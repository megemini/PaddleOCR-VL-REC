# PaddleOCR-VL-Receipt - 从收据中提取信息的SFT模型

## 灵感来源

PaddleOCR-VL不仅是一个OCR模型，同时也是一个视觉语言模型(VLM)。这一双重特性为我们提供了新的思路：既然它是VLM模型，我们就可以使用VLM模型微调的方式来微调OCR模型，而不仅仅局限于表格、公式等预定义的识别任务。

我们意识到，如果能够直接通过模型抽取图片中的结构化信息，就可以大大简化传统OCR流水线中的后续处理流程。传统方法通常需要先进行OCR识别获取文本，然后再通过NLP技术进行信息抽取，而我们的方法试图将这两步合二为一，直接从图像到结构化数据。

## 项目功能

PaddleOCR-VL-Receipt是PaddleOCR-VL的微调版本，专门设计用于从收据中提取结构化信息。该项目包括：

1. **自定义提示工程**：扩展了原始PaddleOCR-VL提示系统，支持用户定义的基于JSON的提示，实现有针对性的信息提取。

2. **结构化数据提取**：将非结构化的收据图像转换为结构化JSON数据，便于与下游应用程序集成。

3. **灵活查询系统**：支持多种查询格式（字符串、列表、字典），以指定应从文档中提取的确切信息。

4. **简化接口**：提供精简的Python API和命令行界面，仅专注于VL识别功能，移除了文档处理的不必要组件。

## 构建过程

该项目通过以下几个关键步骤构建：

1. **基础模型选择**：我们以PaddleOCR-VL-0.9B为基础，这是一个专为文档理解任务设计的视觉语言模型。

2. **自定义数据集准备**：基于 [WildReceipt](https://aistudio.baidu.com/dataset/detail/129038/intro) 我们创建了专门的收据图像数据集，配有相应的JSON注释。数据以特定方式格式化，以教导模型响应自定义提示：

   ```json
   {
       "image_info": [{"matched_text_index": 0, "image_url": "path/to/image.jpg"}],
       "text_info": [
           {"text": "OCR:{\"RECEIPT NUMBER\": \"\"}", "tag": "mask"},
           {"text": "{\"RECEIPT NUMBER\": \"123456789\"}", "tag": "no_mask"}
       ]
   }
   ```

3. **提示工程**：我们设计了新的提示系统，扩展了原始PaddleOCR-VL提示：
   - 对于全量信息：`"OCR:{}"`
   - 对于字符串值：`"OCR:{\"FIELD\":\"\"}"`
   - 对于字典值：`"OCR:{\"FIELD\":{}}"`
   - 对于列表值：`"OCR:{\"FIELD\":[]}"`

4. **模型微调**：使用ERNIE框架，我们在自定义数据集上微调了基础模型。微调过程在A800 GPU上耗时约3小时，损失在整个训练过程中稳步下降。

5. **接口开发**：我们创建了一个简化的Python脚本 [PaddleOCR-VL-REC](https://github.com/megemini/PaddleOCR-VL-REC)，仅专注于VL识别功能，移除了文档预处理、布局检测和图表识别等不必要的组件。

6. **补丁实现**：我们开发了一个补丁来绕过原始PaddleX的限制，该限制只允许四种预定义的提示类型，使我们的自定义提示能够与微调模型一起工作。

## 遇到的挑战

1. **有限的提示支持**：原始PaddleOCR-VL实现仅支持四种预定义的提示类型（'ocr'、'table'、'formula'、'chart'）。我们必须开发一个补丁来绕过这些限制，允许我们的自定义基于JSON的提示工作。

2. **数据准备复杂性**：以所需格式创建训练数据集具有挑战性，因为它需要将图像与特定的JSON结构和提示配对。为了解决这一问题，我们利用ERNIE 4.5 VL模型生成JSON结构的全量数据，用于后续训练任务的数据抽取。同时，我们还开发了自定义工具来正确处理和格式化数据。

3. **模型集成问题**：将微调模型与现有PaddleOCR基础设施集成，需要简化接口的设计，只保留 VL REC MODEL 部分。

4. **JSON解析限制**：原始模型并非设计为输出结构化JSON数据。我们必须使用`json_repair`库实现健壮的JSON解析，以处理可能格式错误的JSON输出。

5. **资源约束**：微调需要大量计算资源，我们必须优化流程以在这些约束内工作。

6. **输出一致性**：确保模型一致地输出有效的JSON格式需要仔细的提示工程和微调策略。

## 我们引以为豪的成就

1. **成功微调**：我们成功微调了PaddleOCR-VL，使其能够理解并响应自定义的基于JSON的提示，将其能力扩展到原始四种任务类型之外。

2. **结构化输出生成**：模型现在可以输出结构化JSON数据而不仅仅是原始文本，使其对下游应用程序更加有用。

3. **灵活查询系统**：我们实现了多功能查询系统，接受字符串、列表或字典，允许用户指定他们想要提取的确切信息。

4. **简化接口**：我们创建了一个干净、专注的API，移除了不必要的复杂性，同时保持了信息提取所需的核心功能。

5. **实际应用**：该解决方案解决了收据自动处理的真实业务需求，在会计、费用管理和财务自动化中有潜在应用。

6. **开源贡献**：我们使我们的工作对社区可用，提供了微调模型和有效使用它所需的工具。

## 我们学到的经验

1. **视觉语言模型适应**：我们学习了如何通过有针对性的微调和提示工程有效地适应预训练视觉语言模型以执行特定领域任务。

2. **自定义提示设计**：我们获得了设计有效提示的见解，这些提示指导模型产生特定格式的结构化输出。

3. **VLM数据格式化**：我们学习了在训练视觉语言模型时正确数据格式化的重要性，特别是如何为最佳学习构建图像-文本对。

4. **模型集成技术**：我们开发了将微调模型与现有框架集成的技术，包括如何解决系统限制和约束。

5. **JSON输出生成**：我们学习了训练模型生成有效JSON输出的策略，这对于最初不是为此目的设计的语言模型来说特别具有挑战性。

6. **资源优化**：我们获得了优化模型训练和推理过程以在计算约束内工作的经验。

## PaddleOCR-VL-Receipt的未来计划

1. **扩展数据集**：可以使用更多行业、种类、语言的数据，针对特定需求进行数据集扩展，以提高模型的泛化能力。

2. **多语言支持**：目前专注于英文收据，我们旨在扩展对多种语言收据的支持，特别是英语和其他主要语言。

3. **增强字段提取**：我们计划改进模型提取更广泛字段的能力，包括更复杂的税务计算、折扣信息和行项目详情。

4. **性能优化**：我们将致力于优化模型以实现更快的推理和更低的资源需求，可能通过量化和模型压缩技术。

5. **错误处理和验证**：我们计划实现更健壮的错误处理和输出验证，以确保提取的信息准确且格式正确。

6. **工具持续改进**：我们计划针对PaddleOCR-VL类似模型的信息抽取需求，持续改进PaddleOCR-VL-REC工具，优化接口设计和功能实现，为用户提供更好的使用体验。

